<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/manager.css">
  <link rel="stylesheet" href="css/all.min.css">
  <link rel="stylesheet" href="css/sweetalert2.min.css">
  <style>
    .body {
      background-color: #f0cece;
    }

    .stop {
      background-color: #ffcccc;
    }
  </style>
</head>

<body>

  <div class="container-fluid">
    <div class="row">
      <div class="col">
        <button class="openbtn fw-900" onclick="openNav()">☰ 後臺管理系統</button>
      </div>
      <div class="col text-end">
        <span class="text-dark h3 mt-3" id="user_message"></span>
        <button type="button" id="loginoutButton" class="mt-3 btn btn-outline-danger">登出</button>
      </div>
    </div>
  </div>

  <div id="mySidebar" class="sidebar">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">×</a>
    <a href="#" onclick="openTab(event, 'Home')">首頁</a>
    <a href="#" onclick="openTab(event, 'member')"><i class="fa-solid fa-user"></i>&nbsp;會員管理</a>
    <a href="#" class="dropdown-toggle-split nav-link dropdown-toggle tab" data-bs-toggle="dropdown"
      aria-expanded="false">
      <i class="fa-brands fa-pagelines"></i>&nbsp;商品管理
    </a>
    <ul class="dropdown-menu">
      <li><a href="#" onclick="openTab(event, 'product01')">新增商品</a></li>
      <li><a href="#" onclick="openTab(event, 'product02')">商品總覽</a></li>
    </ul>
    <a href="#" onclick="openTab(event, 'news')"><i class="fa-solid fa-rss"></i>&nbsp;消息管理</a>
    <a href="#" onclick="openTab(event, 'cart')"><i class="fa-solid fa-chalkboard"></i>&nbsp;訂單管理</a>
    <a class="nav-link disabled" aria-disabled="true">待定</a>
  </div>

  <div id="main">
    <div class="tab-content" id="myTabContent">

      <!-- 後臺首頁 -->
      <div class="tab-pane fade show active" id="Home">
        <h2>首頁</h2>
      </div>

      <!-- 會員 -->
      <div class="tab-pane fade" id="member">
        <div class="container pt-5">
          <table class="table table-bordered table-hover table-sm border-success table-rwd">
            <caption class="text-end">會員列表</caption>
            <thead class="table-dark">
              <tr>
                <th>編號</th>
                <th>帳號</th>
                <th>Email</th>
                <th>停權</th>
                <th>註冊時間</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="mydata">
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>
                  <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#updateModal">更新</button>
                  <button class="btn btn-danger">刪除</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="container">
          <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-center" id="pageList">
              <li class="page-item"><a class="page-link" href="#" onclick="drawTable(0)">1</a></li>
            </ul>
          </nav>
        </div>

        <!-- updateModal -->
        <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header text-bg-success">
                <h1 class="modal-title fs-3 fw-900" id="exampleModalLabel">會員更新</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label for="updateModal_username" class="form-label">帳號</label>
                  <input type="text" class="form-control" disabled id="updateModal_username"
                    name="updateModal_username">
                </div>
                <div class="mb-3">
                  <label for="updateModal_email" class="form-label">Email</label>
                  <input type="email" class="form-control" id="updateModal_email" name="updateModal_email">
                </div>
                <div class="mb-3">
                  <label for="updateModal_state" class="form-label">狀態</label>
                  <input type="number" class="form-control" min="0" max="1" id="updateModal_state"
                    oninput="checkStateInput(this)" name="updateModal_state">
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="updateModal_updata_btn">確認</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 商品總覽 -->
      <div class="tab-pane fade" id="product01">
        <div class="container">
          <div class="text-end">
            <button class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#addModal">新增</button>
          </div>
          <table class="table table-bordered table-hover table-sm border-success table-rwd">
            <caption class="text-end">消息列表</caption>
            <thead class="table-dark">
              <tr>
                <th class="text-center">編號</th>
                <th class="text-center">圖片</th>
                <th class="text-center">標題</th>
                <th class="text-center">描述</th>
                <th class="text-center">價錢</th>
                <th class="text-center">建立時間</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="product01">
              <tr>
                <td class="py-4"></td>
                <td class="py-4"></td>
                <td class="py-4"></td>
                <td class="py-4"></td>
                <td class="py-4"></td>
                <td class="py-4"></td>
                <td class="text-center py-4">
                  <div class="d-flex align-content-center justify-content-center">
                    <button class="btn btn-success me-2" data-bs-toggle="modal"
                      data-bs-target="#updatenewsModal">更新</button>
                    <button class="btn btn-danger">刪除</button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      <!-- 商品新增 -->
      <div class="tab-pane fade" id="pro-create">
        <h2>新增商品</h2>
        <p>This is the contact tab content.</p>
      </div>

      <!-- 消息管理 -->
      <div class="tab-pane fade" id="news">
        <div class="container">
          <div class="text-end">
            <button class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#addModal">新增</button>
          </div>
          <table class="table table-bordered table-hover table-sm border-success table-rwd">
            <caption class="text-end">消息列表</caption>
            <thead class="table-dark">
              <tr>
                <th class="text-center">編號</th>
                <th class="text-center">大標</th>
                <th class="text-center">標題</th>
                <th class="text-center">文章</th>
                <th class="text-center">建立時間</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="mynews">
              <tr>
                <td class="py-4">1</td>
                <td class="py-4"></td>
                <td class="py-4">
                </td>
                <td class="py-4">
                </td>
                <td class="text-center py-4">
                  <div class="d-flex align-content-center justify-content-center">
                    <button class="btn btn-success me-2" data-bs-toggle="modal"
                      data-bs-target="#updatenewsModal">更新</button>
                    <button class="btn btn-danger">刪除</button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Addmodal -->
        <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="addModalLabel">新增消息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="mb-3 form-floating">
                <input type="text" class="form-control" placeholder="" id="number" name="number" readonly>
                <label for="number">編號</label>
              </div>
              <div class="modal-body">
                <div class="mb-3 form-floating">
                  <input type="text" class="form-control" placeholder="" id="name" name="name">
                  <label for="name">大標</label>
                  <div class="valid-feedback">字數符合規定</div>
                  <div class="invalid-feedback">字數不符合規定</div>
                </div>
                <div class="mb-3 form-floating">
                  <input type="text" class="form-control" placeholder="" id="heading" name="heading">
                  <label for="heading">標題</label>
                  <div class="valid-feedback">數字正確(1~100)</div>
                  <div class="invalid-feedback">數字不正確</div>
                </div>
                <div class="mb-3">
                  <div class="form-floating">
                    <textarea class="form-control" placeholder="Leave a comment here" id="content"
                      style="height: 100px"></textarea>
                    <label for="content">文章</label>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                <button type="button" class="btn btn-info" id="ok_button">確認</button>
              </div>
            </div>
          </div>
        </div>

        <!-- UPdatenewsModal -->
        <div class="modal fade" id="updatenewsModal" tabindex="-1" aria-labelledby="updateModalLabel"
          aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="updateModalLabel">更新消息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label for="updateId" class="form-label">編號</label>
                  <input type="text" class="form-control" id="updateId" name="updateId" readonly>
                </div>
                <div class="mb-3 form-floating">
                  <input type="text" class="form-control" placeholder="" id="updateTitle" name="updateTitle"
                    list="myoption">
                  <label for="updateTitle">Title</label>
                  <div class="valid-feedback">字數符合規定</div>
                  <div class="invalid-feedback">字數不符合規定</div>
                </div>
                <div class="mb-3">
                  <label for="updateHeading" class="form-label">Heading</label>
                  <input type="number" class="form-control" id="updateHeading" name="updateHeading">
                  <div class="valid-feedback">數字正確(1~100)</div>
                  <div class="invalid-feedback">數字不正確</div>
                </div>
                <div class="mb-3">
                  <div class="form-floating">
                    <textarea class="form-control" placeholder="Leave a comment here" id="updateContent"
                      style="height: 100px"></textarea>
                    <label for="updateContent">Content</label>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                <button type="button" class="btn btn-info" id="update_button">更新</button>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- 訂單管理 -->
      <div class="tab-pane fade" id="cart">
        <h2>Contact Content</h2>
        <p>This is the contact tab content.</p>
      </div>
    </div>
  </div>



  <script src="js/jquery-3.7.1.min.js"></script>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="js/manager.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/sweetalert2.all.min.js"></script>

  <!-- product商品資料新增 -->
  <!-- member會員資料引入 -->
  <script>
    // 限定輸入0或1
    function checkStateInput(input) {
      if (input.value !== '0' && input.value !== '1') {
        input.value = '';
        Swal.fire({
          title: "輸入錯誤",
          text: "請輸入 0 或 1",
          icon: "error",
          showClass: {
            popup: `
                  animate__animated
                  animate__fadeInUp
                  animate__faster
                `
          },
          hideClass: {
            popup: `
                  animate__animated
                  animate__fadeOutDown
                  animate__faster
                `
          }
        });
      }
    }

    var u_id; //for update
    var newData = [];
    $(function () {
      //讀取會員資料
      $.ajax({
        type: "GET",
        url: "api/manager-control/member_read-api.php",
        async: false,
        dataType: "json",
        success: showdata,
        error: function () {
          alert("error-member-Read-api.php");
        }
      });

      //#update_btn 更新按鈕監聽
      // $("#mydata #update_btn").click(function () {
      $("body").on("click", "#mydata #update_btn", function () {
        console.log($(this).data("id") + $(this).data("email") + $(this).data("username") + $(this).data("state"));
        u_id = $(this).data("id");
        $("#updateModal_username").val($(this).data("username"));
        $("#updateModal_email").val($(this).data("email"));
        $("#updateModal_state").val($(this).data("state"));
      });



      //delete_btn 刪除按鈕監聽
      // $("#mydata #delete_btn").click(function () {
      $("body").on("click", "#mydata #delete_btn", function () {
        Swal.fire({
          title: "確定要刪除?",
          text: "刪除後無法復原!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "確定!",
          cancelButtonText: "取消",
        }).then((result) => {
          if (result.isConfirmed) {
            console.log($(this).data("id"));
            // 傳遞刪除資料至後端api {"ID":"XX"}
            var dataJSON = {};
            dataJSON["ID"] = $(this).data("id");
            console.log(JSON.stringify(dataJSON));

            $.ajax({
              type: "POST",
              url: "api/manager-control/member_delete-api.php",
              data: JSON.stringify(dataJSON),
              dataType: "json",
              success: showdata_delete,
              error: function () {
                alert("error-member_delete-api.php");
              }
            });
          }
        });
      });


      //#updateModal_updata_btn 監聽
      $("#updateModal_updata_btn").click(function () {
        //傳遞更新資料至後端api {"ID":"XX", "Email":"XXXXX"}
        var dataJSON = {};
        dataJSON["ID"] = u_id;
        dataJSON["Email"] = $("#updateModal_email").val();
        dataJSON["State"] = $("#updateModal_state").val();
        console.log(JSON.stringify(dataJSON));

        $.ajax({
          type: "POST",
          url: "api/manager-control/member_update_api.php",
          data: JSON.stringify(dataJSON),
          dataType: "json",
          success: showdata_update,
          error: function () {
            alert("error-member-Update_api.php");
          }
        });
      });
    });
    function showdata(data) {
      //整理資料儲存為二維陣列
      data.data.forEach(function (item, key) {
        console.log(key);
        if (key % 6 == 0) {
          newData.push([]);
        }
        var page = parseInt(key / 6);
        newData[page].push(item);

      });
      drawTable(0);
      console.log(newData);

      //產生頁碼
      $("#pageList").empty();
      newData.forEach(function (item, key) {
        var thisPage = key + 1;
        var strHTML = '<li class="page-item"><a class="page-link" href="#" onclick="drawTable(' + key + ')">' + thisPage + '</a></li>';
        $("#pageList").append(strHTML);
      });
    }

    function drawTable(page) {
      $("#mydata").empty();
      newData[page].forEach(function (item) {
        var stateText;
        var stateClass;
        switch (item.State) {
          case '0':
            stateText = '停權';
            stateClass = 'stop';
            break;
          case '1':
            stateText = '正常';
            break;
          default:
            stateText = '未知狀態';
            break;
        }

        var strHTML = '<tr><td>' + item.ID + '</td><td>' +
          item.Username + '</td><td>' +
          item.Email + '</td><td>' +
          stateText + '</td><td>' +
          item.Creat_time + '</td><td><button class="btn btn-success me-2" data-id="' +
          item.ID + '" data-email="' +
          item.Email + '"  data-state="' +
          item.State + '" data-username="' +
          item.Username + '" id="update_btn"  data-bs-toggle="modal" data-bs-target="#updateModal">更新</button><button class="btn btn-danger" id="delete_btn" data-id="' + item.ID + '">刪除</button></td></tr>';

        $("#mydata").append(strHTML);
      });
    }


    function showdata_update(data) {
      console.log(data);
      if (data.state) {
        Swal.fire({
          position: "center",
          icon: "success",
          title: "成功儲存！",
          showConfirmButton: false,
          timer: 1500
        }).then(() => {
          // 關閉模態對話框
          $("#updateModal").modal("hide");
          location.replace(login.html);
        });
      } else {
        alert(data.message);
      }
    }


    function showdata_delete(data) {
      console.log(data);
      if (data.state) {
        alert(data.message);
        location.reload();
      } else {
        alert(data.message);
      }
    }
  </script>

  <!-- 消息管理 -->
  <script>
    // read
    $(function () {
      $.ajax({
        type: "GET",
        url: "api/news/news-read-api.php",
        dataType: "json",
        success: shownewsdata,
        error: function () {
          alert("error-api/news/news-read-api.php");
        }
      });
    });

    function shownewsdata(data) {
      console.log(data);

      var strHTMLnews = '';
      $("#mynews").empty();
      data.data.forEach(function (item) {
        console.log(item.ID);
        strHTMLnews += '<tr><td class="py-4">'
          + item.ID + '</td><td class="py-4">'
          + item.Title + '</td><td class="py-4">'
          + item.Heading + '</td><td class="py-4">'
          + item.content +
          '</td><td class="text-center py-4">'
          + item.Created_at +
          '</td><td class="text-center py-4"><div class="d-flex align-content-center justify-content-center"><button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#updatenewsModal">更新</button><button class="btn btn-danger">刪除</button></div></td></tr>';
      });
      $("#mynews").append(strHTMLnews);

    }

    // create
    var flag_name = false;
    var flag_heading = false;
    var flag_content = false;

    // 監聽_及時監聽 #name
    $(function () {
      $("#name").bind("input propertychange", function () {
        console.log($(this).val().length);
        if ($(this).val().length > 0 && $(this).val().length < 10) {
          // 字數符合
          $(this).removeClass("is-invalid");
          $(this).addClass("is-valid");
          flag_name = true;
        } else {
          // 字數不符合
          $(this).removeClass("is-valid");
          $(this).addClass("is-invalid");
          flag_name = false;
        }
      });

      $("#heading").bind("input propertychange", function () {
        console.log($(this).val().length);
        if ($(this).val().length > 0 && $(this).val().length < 10) {
          // 字數符合
          $(this).removeClass("is-invalid");
          $(this).addClass("is-valid");
          flag_heading = true;
        } else {
          // 字數不符合
          $(this).removeClass("is-valid");
          $(this).addClass("is-invalid");
          flag_heading = false;
        }
      });

      $("#content").bind("input propertychange", function () {
        console.log($(this).val().length);
        if ($(this).val().length > 50 && $(this).val().length < 1000) {
          // 字數符合
          $(this).removeClass("is-invalid");
          $(this).addClass("is-valid");
          flag_content = true;
        } else {
          // 字數不符合
          $(this).removeClass("is-valid");
          $(this).addClass("is-invalid");
          flag_content = false;
        }
      });

      // 按鈕監聽
      $("#ok_button").click(function () {
        if (flag_name && flag_heading && flag_content) {
          console.log($("#name").val());

          var dataJSON = {};
          dataJSON["Title"] = $("#name").val();
          dataJSON["Heading"] = $("#heading").val();
          dataJSON["content"] = $("#content").val();
          console.log(JSON.stringify(dataJSON));
          //傳遞至後端
          $.ajax({
            type: "POST",
            url: "api/news/news-create-api.php",
            data: JSON.stringify(dataJSON),
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: showdatanews02,
            error: function (xhr, status, error) {
              console.log(xhr.responseText);
              alert("error-api/news/news-create-api.php");
            }
          });
        } else {
          alert("欄位有誤, 請修正!");
        }
      });
    });

    function showdatanews02(data) {
      console.log(data);
    }

  </script>


  <!-- 後台登入 -->
  <script>
    $(function () {
      // 判斷是否登入
      if (getCookie("UID01") != "") {
        // UID01存在，傳遞至後端api，判斷是否合法
        var dataJSON = {};
        dataJSON["UID01"] = getCookie("UID01");
        console.log(JSON.stringify(dataJSON));
        $.ajax({
          type: "POST",
          url: "api/admin/manager-check_UID01-api.php",
          data: JSON.stringify(dataJSON),
          dataType: "json",
          success: showdata_Check_UID,
          error: function () {
            alert("error-api/manager-check_UID01-api.php");
          }
        });
      }

      // 登出按鈕監聽 #loginoutButton
      $("#loginoutButton").click(function () {
        setCookie("UID01", "", 7);
        location.href = "manager-login.html";
      });
    });
    function showdata_Check_UID(data) {
      console.log(data);
      if (data.state) {
        // 顯示登出按鈕
        $("#user_message").text("登入中！");
      }
    }


    // w3s存入cookie
    function setCookie(cname, cvalue, exdays) {
      const d = new Date();
      d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
      let expires = "expires=" + d.toUTCString();
      document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    //w3s
    function getCookie(cname) {
      let name = cname + "=";
      let decodedCookie = decodeURIComponent(document.cookie);
      let ca = decodedCookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }

  </script>

</body>

</html>